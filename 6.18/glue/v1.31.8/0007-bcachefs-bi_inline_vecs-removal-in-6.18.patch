From b0932abb6dec63dc4ec293eced52c3f55684029c Mon Sep 17 00:00:00 2001
From: Xarblu <xarblu@protonmail.com>
Date: Tue, 14 Oct 2025 21:51:55 +0200
Subject: [PATCH 7/8] bcachefs: bi_inline_vecs removal in 6.18

Based on https://github.com/torvalds/linux/commit/d86eaa0f3c56da286853b698b45c8ce404291082
---
 fs/bcachefs/journal/init.c | 5 +++++
 1 file changed, 5 insertions(+)

diff --git a/fs/bcachefs/journal/init.c b/fs/bcachefs/journal/init.c
index f809459ec8e6..5c815745851c 100644
--- a/fs/bcachefs/journal/init.c
+++ b/fs/bcachefs/journal/init.c
@@ -535,8 +535,13 @@ int bch2_dev_journal_init(struct bch_dev *ca, struct bch_sb *sb)
 		 * performance can be sensitive to anything that affects journal
 		 * pipelining.
 		 */
+# if LINUX_VERSION_CODE < KERNEL_VERSION(6,18,0)
 		ja->bio[i] = kvzalloc(struct_size(ja->bio[i], bio.bi_inline_vecs,
 				     nr_bvecs), GFP_KERNEL);
+# else
+		ja->bio[i] = kvzalloc(sizeof(*ja->bio[i]) +
+				     sizeof(struct bio_vec) * nr_bvecs, GFP_KERNEL);
+# endif
 		if (!ja->bio[i])
 			return bch_err_throw(c, ENOMEM_dev_journal_init);
 
-- 
2.51.0

