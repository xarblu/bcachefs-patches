From c0347231a45001de6252fc21ff2931d2b9eee39c Mon Sep 17 00:00:00 2001
From: Xarblu <xarblu@protonmail.com>
Date: Tue, 14 Oct 2025 20:56:19 +0200
Subject: [PATCH 1/7] bcachefs: kvmalloc_noprof changes for 6.18

---
 fs/bcachefs/util/darray.c | 5 +++++
 fs/bcachefs/util/util.h   | 5 +++++
 2 files changed, 10 insertions(+)

diff --git a/fs/bcachefs/util/darray.c b/fs/bcachefs/util/darray.c
index 6940037bd19e..2a04077975fa 100644
--- a/fs/bcachefs/util/darray.c
+++ b/fs/bcachefs/util/darray.c
@@ -3,6 +3,7 @@
 #include <linux/log2.h>
 #include <linux/rcupdate.h>
 #include <linux/slab.h>
+#include <linux/version.h>
 #include <linux/vmalloc.h>
 #include "darray.h"
 
@@ -24,7 +25,11 @@ int __bch2_darray_resize_noprof(darray_char *d, size_t element_size, size_t new_
 
 		void *old = d->data;
 		void *new = likely(bytes < INT_MAX)
+# if LINUX_VERSION_CODE < KERNEL_VERSION(6,18,0)
 			? kvmalloc_noprof(bytes, gfp)
+# else
+			? kvmalloc_node_align_noprof(bytes, 1, gfp, NUMA_NO_NODE)
+# endif
 			: vmalloc_noprof(bytes);
 		if (!new)
 			return -ENOMEM;
diff --git a/fs/bcachefs/util/util.h b/fs/bcachefs/util/util.h
index b74d5efff785..d24f62f46995 100644
--- a/fs/bcachefs/util/util.h
+++ b/fs/bcachefs/util/util.h
@@ -16,6 +16,7 @@
 #include <linux/ratelimit.h>
 #include <linux/slab.h>
 #include <linux/sort.h>
+#include <linux/version.h>
 #include <linux/vmalloc.h>
 #include <linux/workqueue.h>
 
@@ -60,7 +61,11 @@ static inline void *bch2_kvmalloc_noprof(size_t n, gfp_t flags)
 {
 	void *p = unlikely(n >= INT_MAX)
 		? vmalloc_noprof(n)
+# if LINUX_VERSION_CODE < KERNEL_VERSION(6,18,0)
 		: kvmalloc_noprof(n, flags & ~__GFP_ZERO);
+# else
+		: kvmalloc_node_align_noprof(n, 1, flags & ~__GFP_ZERO, NUMA_NO_NODE);
+# endif
 	if (p && (flags & __GFP_ZERO))
 		memset(p, 0, n);
 	return p;
-- 
2.51.0

