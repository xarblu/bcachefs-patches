From fa4ae07bdc76e7d0435f23790a804f62e31480f0 Mon Sep 17 00:00:00 2001
From: Xarblu <xarblu@protonmail.com>
Date: Tue, 14 Oct 2025 21:17:15 +0200
Subject: [PATCH 3/7] bcachefs: bio_iov_iter_get_pages changes for 6.18

---
 fs/bcachefs/vfs/direct.c | 9 +++++++++
 1 file changed, 9 insertions(+)

diff --git a/fs/bcachefs/vfs/direct.c b/fs/bcachefs/vfs/direct.c
index 648325492694..4ecd930c5281 100644
--- a/fs/bcachefs/vfs/direct.c
+++ b/fs/bcachefs/vfs/direct.c
@@ -19,6 +19,7 @@
 #include <linux/pagemap.h>
 #include <linux/prefetch.h>
 #include <linux/task_io_accounting_ops.h>
+#include <linux/version.h>
 
 /* O_DIRECT reads */
 
@@ -148,7 +149,11 @@ static int bch2_direct_IO_read(struct kiocb *req, struct iov_iter *iter)
 		bio->bi_iter.bi_sector	= offset >> 9;
 		bio->bi_private		= dio;
 
+# if LINUX_VERSION_CODE < KERNEL_VERSION(6,18,0)
 		ret = bio_iov_iter_get_pages(bio, iter);
+# else
+		ret = bio_iov_iter_get_pages(bio, iter, 0);
+# endif
 		if (ret < 0) {
 			/* XXX: fault inject this path */
 			bio->bi_status = BLK_STS_RESOURCE;
@@ -461,7 +466,11 @@ static __always_inline long bch2_dio_write_loop(struct dio_write *dio)
 		EBUG_ON(current->faults_disabled_mapping);
 		current->faults_disabled_mapping = mapping;
 
+# if LINUX_VERSION_CODE < KERNEL_VERSION(6,18,0)
 		ret = bio_iov_iter_get_pages(bio, &dio->iter);
+# else
+		ret = bio_iov_iter_get_pages(bio, &dio->iter, 0);
+# endif
 
 		dropped_locks = fdm_dropped_locks();
 
-- 
2.51.0

